<?xml version="1.0" encoding="utf-8"?>
<modification>
  <code>affiliate</code>
  <name>affiliate</name>
  <version>4.0.2</version>
  <author>NeitrinoZull</author>
  <link>http://partnerkaprog.ru/</link>
  <file path="admin/controller/extension/module/affiliate.php">
    <operation error="skip">
      <search>
      <![CDATA[
        function index()
      ]]>
      </search>
      <add position="after" offset="2">
      <![CDATA[
$this->load->model('localisation/order_status');
$data['order_statuses'] = $this->model_localisation_order_status->getOrderStatuses();
$this->load->model('module/affiliate');
$data['elements'] = $this->model_module_affiliate->getInfoModule();
if ($this->request->server['REQUEST_METHOD'] != 'POST') {
  $this->model_module_affiliate->createAffiliate();
}
$data['entry_add'] = $this->language->get('entry_add');
$data['entry_category_visible'] = $this->language->get('entry_category_visible');
$data['entry_total'] = $this->language->get('entry_total');
$data['entry_days'] = $this->language->get('entry_days');
$data['entry_order_status'] = $this->language->get('entry_order_status');
$data['entry_payment'] = $this->language->get('entry_payment');
$data['is_affiliate_dopfun'] = $this->model_module_affiliate->getExists('is_affiliate_dopfun');
$data['mod_affiliate_dopfun'] = $this->language->get('mod_affiliate_dopfun');
$data['is_affiliate_trackingproduct'] = $this->model_module_affiliate->getExists('is_affiliate_trackingproduct');
$data['mod_affiliate_trackingproduct'] = $this->language->get('mod_affiliate_trackingproduct');

$data['text_bonus'] = $this->language->get('text_bonus');
$data['text_cheque'] = $this->language->get('text_cheque');
$data['text_paypal'] = $this->language->get('text_paypal');
$data['text_bank'] = $this->language->get('text_bank');
$data['text_qiwi'] = $this->language->get('text_qiwi');
$data['text_card'] = $this->language->get('text_card');
$data['text_yandex'] = $this->language->get('text_yandex');
$data['text_webmoney_wmr'] = $this->language->get('text_webmoney_wmr');
$data['text_webmoney_wmz'] = $this->language->get('text_webmoney_wmz');
$data['text_webmoney_wmu'] = $this->language->get('text_webmoney_wmu');
$data['text_webmoney_wme'] = $this->language->get('text_webmoney_wme');
$data['text_webmoney_wmy'] = $this->language->get('text_webmoney_wmy');
$data['text_webmoney_wmb'] = $this->language->get('text_webmoney_wmb');
$data['text_webmoney_wmg'] = $this->language->get('text_webmoney_wmg');
$data['text_alert_pay'] = $this->language->get('text_alert_pay');
$data['text_moneybookers'] = $this->language->get('text_moneybookers');
$data['text_liqpay'] = $this->language->get('text_liqpay');
$data['text_sage_pay'] = $this->language->get('text_sage_pay');
$data['text_two_checkout'] = $this->language->get('text_two_checkout');
$data['text_google_wallet'] = $this->language->get('text_google_wallet');

$data['affiliate_qiwi'] = (bool)$this->config->get('affiliate_qiwi');
$data['affiliate_card'] = (bool)$this->config->get('affiliate_card');
$data['affiliate_yandex'] = (bool)$this->config->get('affiliate_yandex');
$data['affiliate_webmoney_wmr'] = (bool)$this->config->get('affiliate_webmoney_wmr');    
$data['affiliate_webmoney_wmz'] = (bool)$this->config->get('affiliate_webmoney_wmz');
$data['affiliate_webmoney_wmu'] = (bool)$this->config->get('affiliate_webmoney_wmu');
$data['affiliate_webmoney_wme'] = (bool)$this->config->get('affiliate_webmoney_wme');
$data['affiliate_webmoney_wmy'] = (bool)$this->config->get('affiliate_webmoney_wmy');
$data['affiliate_webmoney_wmb'] = (bool)$this->config->get('affiliate_webmoney_wmb');
$data['affiliate_webmoney_wmg'] = (bool)$this->config->get('affiliate_webmoney_wmg');
$data['affiliate_alert_pay'] = (bool)$this->config->get('affiliate_alert_pay');
$data['affiliate_moneybookers'] = (bool)$this->config->get('affiliate_moneybookers');
$data['affiliate_liqpay'] = (bool)$this->config->get('affiliate_liqpay');
$data['affiliate_sage_pay'] = (bool)$this->config->get('affiliate_sage_pay');
$data['affiliate_two_checkout'] = (bool)$this->config->get('affiliate_two_checkout');
$data['affiliate_google_wallet'] = (bool)$this->config->get('affiliate_google_wallet');
  
$data['affiliate_bonus'] = (bool)$this->config->get('affiliate_bonus');
$data['affiliate_category_visible'] = (bool)$this->config->get('affiliate_category_visible');

if((int)$this->config->get('affiliate_order_status_id')!=0){
  $data['affiliate_order_status_id'] = (int)$this->config->get('affiliate_order_status_id');
  $data['affiliate_cheque'] = (bool)$this->config->get('affiliate_cheque');
  $data['affiliate_paypal'] = (bool)$this->config->get('affiliate_paypal');
  $data['affiliate_bank'] = (bool)$this->config->get('affiliate_bank');
  $data['affiliate_days'] = (int)$this->config->get('affiliate_days');
  $data['affiliate_total'] = (float)$this->config->get('affiliate_total');
}
else{
  $data['affiliate_order_status_id'] = (int)$this->config->get('config_complete_status_id');
  $data['affiliate_cheque'] = true;
  $data['affiliate_paypal'] = true;
  $data['affiliate_bank'] = true;
  $data['affiliate_days'] = 7;
  $data['affiliate_total'] = 100;
}
$data['entry_affiliate_sumbol'] = $this->language->get('entry_affiliate_sumbol');
$data['affiliate_sumbol'] = $this->config->get('affiliate_sumbol');
if (!$this->config->get('affiliate_sumbol')) {
  $data['affiliate_sumbol'] = '1';
}
$data['affiliate_add'] = (bool)$this->config->get('affiliate_add');
$data['affiliate_number_tracking'] = (bool)$this->config->get('affiliate_number_tracking');
$data['entry_number_tracking'] = $this->language->get('entry_number_tracking');
]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/extension/module/affiliate.tpl">
    <operation error="skip">
      <search><![CDATA[
        $action;
            ]]></search>
      <add position="after"><![CDATA[
      <?php  
        if (file_exists(DIR_TEMPLATE.'module/affiliate_settings.tpl')) {
          require_once(DIR_TEMPLATE.'module/affiliate_settings.tpl');
        } 
      ?>
            ]]></add>
    </operation>
  </file>
  <!--  Home :: Coupon --> 
  <file path="admin/controller/marketing/coupon.php">
    <operation error="skip">
      <search>
      <![CDATA[
$data['column_action'] = $this->language->get('column_action');
      ]]>
      </search>
      <add position="after">
      <![CDATA[
$data['button_insert_tracking'] = $this->language->get('button_insert_tracking');
$data['inserttracking'] = $this->url->link('marketing/coupon/inserttracking', 'token=' . $this->session->data['token'] . $url, 'SSL');
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
$this->model_marketing_coupon->deleteCoupon($coupon_id);
      ]]>
      </search>
      <add position="after">
      <![CDATA[
$this->load->model('module/affiliate');
$this->model_module_affiliate->dellTrackingCoupon($coupon_id);
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search trim="true" index="0">
      <![CDATA[
$this->error['code'] = $this->language->get('error_code');
      ]]>
      </search>
      <add position="replace">
      <![CDATA[
$this->load->model('module/affiliate');
if($this->model_module_affiliate->isAffilateCoupon($this->request->get['coupon_id'])){
  $this->error['code'] = $this->language->get('error_code');
} 
$this->load->model('marketing/coupon');
      ]]>
      </add>
    </operation>
  </file>
    <!-- statistic menu -->
  <file path="admin/controller/common/menu.php">
    <operation error="skip">
      <search>
      <![CDATA[$data['text_report_affiliate_activity']]]>
      </search>
      <add position="after">
      <![CDATA[
        $data['text_report_affiliate_statistics'] = $this->language->get('text_report_affiliate_statistics');
        $data['text_report_affiliate_statistics_all'] = $this->language->get('text_report_affiliate_statistics_all');
        $data['report_affiliate_statistics'] = $this->url->link('report/affiliate_statistics', 'token=' . $this->session->data['token'], 'SSL');
        $data['report_affiliate_statistics_all'] = $this->url->link('report/affiliate_statistics_all', 'token=' . $this->session->data['token'], 'SSL');  
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/controller/marketing/coupon.php">
    <operation error="skip">
      <search>
      <![CDATA[
function index()
      ]]>
      </search>
      <add position="before">
      <![CDATA[    
  public function inserttracking() {
      $this->language->load('marketing/coupon');

      $this->document->setTitle($this->language->get('heading_title'));
    
    $this->load->model('marketing/coupon');
    
      if ($this->request->server['REQUEST_METHOD'] == 'POST') {
      $this->load->model('module/affiliate');
      $this->model_module_affiliate->addTrackingCoupon($this->request->post);
      $this->session->data['success'] = $this->language->get('text_success');

      $url = '';

      if (isset($this->request->get['sort'])) {
        $url .= '&sort=' . $this->request->get['sort'];
      }

      if (isset($this->request->get['order'])) {
        $url .= '&order=' . $this->request->get['order'];
      }
      
      if (isset($this->request->get['page'])) {
        $url .= '&page=' . $this->request->get['page'];
      }
            
      $this->response->redirect($this->url->link('marketing/coupon', 'token=' . $this->session->data['token'] . $url, 'SSL'));
      }
    
      $this->getFormTracking();
    }

    private function getFormTracking() {
      $data['heading_title'] = $this->language->get('heading_title');

      $data['text_enabled'] = $this->language->get('text_enabled');
      $data['text_disabled'] = $this->language->get('text_disabled');
      $data['text_yes'] = $this->language->get('text_yes');
      $data['text_no'] = $this->language->get('text_no');
      $data['text_percent'] = $this->language->get('text_percent');
      $data['text_amount'] = $this->language->get('text_amount');
  
    $data['entry_discount'] = $this->language->get('entry_discount');
    $data['entry_type'] = $this->language->get('entry_type');
    $data['entry_total'] = $this->language->get('entry_total');
    $data['entry_product'] = $this->language->get('entry_product');

      $data['button_save'] = $this->language->get('button_save');
      $data['button_cancel'] = $this->language->get('button_cancel');

    $data['tab_general'] = $this->language->get('tab_general');
    $data['tab_coupon_history'] = $this->language->get('tab_coupon_history');

    $data['token'] = $this->session->data['token'];
  
    if (isset($this->request->get['coupon_id'])) {
      $data['coupon_id'] = $this->request->get['coupon_id'];
    } else {
      $data['coupon_id'] = 0;
    }
        
     if (isset($this->error['warning'])) {
      $data['error_warning'] = $this->error['warning'];
    } else {
      $data['error_warning'] = '';
    }  

    $url = '';
      
    if (isset($this->request->get['page'])) {
      $url .= '&page=' . $this->request->get['page'];
    }

    if (isset($this->request->get['sort'])) {
      $url .= '&sort=' . $this->request->get['sort'];
    }

    if (isset($this->request->get['order'])) {
      $url .= '&order=' . $this->request->get['order'];
    }

      $data['breadcrumbs'] = array();

       $data['breadcrumbs'][] = array(
           'text'      => $this->language->get('text_home'),
      'href'      => $this->url->link('common/home', 'token=' . $this->session->data['token'], 'SSL'),
          'separator' => false
       );

       $data['breadcrumbs'][] = array(
           'text'      => $this->language->get('heading_title'),
      'href'      => $this->url->link('marketing/coupon', 'token=' . $this->session->data['token'] . $url, 'SSL'),
          'separator' => ' :: '
       );
                
    $data['action'] = $this->url->link('marketing/coupon/inserttracking', 'token=' . $this->session->data['token'] . $url, 'SSL');
    
    $data['cancel'] = $this->url->link('marketing/coupon', 'token=' . $this->session->data['token'] . $url, 'SSL');
      
    if (isset($this->request->get['coupon_id']) && (!$this->request->server['REQUEST_METHOD'] != 'POST')) {
          $coupon_info = $this->model_marketing_coupon->getCoupon($this->request->get['coupon_id']);
      }     
    
      if (isset($this->request->post['type'])) {
          $data['type'] = $this->request->post['type'];
      } elseif (!empty($coupon_info)) {
      $data['type'] = $coupon_info['type'];
    } else {
          $data['type'] = '';
      }
    
      if (isset($this->request->post['discount'])) {
          $data['discount'] = $this->request->post['discount'];
      } elseif (!empty($coupon_info)) {
      $data['discount'] = $coupon_info['discount'];
    } else {
          $data['discount'] = '';
      }

      if (isset($this->request->post['total'])) {
          $data['total'] = $this->request->post['total'];
      } elseif (!empty($coupon_info)) {
      $data['total'] = $coupon_info['total'];
    } else {
          $data['total'] = '';
      }
    $data['header'] = $this->load->controller('common/header');
    $data['column_left'] = $this->load->controller('common/column_left');
    $data['footer'] = $this->load->controller('common/footer');

    $this->response->setOutput($this->load->view('sale/coupon_tracking.tpl', $data));    
    }
      ]]>
      </add>
    </operation>
  </file>
    <!--add affiliate-->
  <file path="admin/view/template/marketing/coupon_list.tpl">
    <operation error="skip">
      <search index="0">
      <![CDATA[
</button>
      ]]>
      </search>
      <add position="after">
      <![CDATA[
        <a onclick="location = '<?php echo $inserttracking; ?>'" class="btn btn-primary"><?php echo $button_insert_tracking; ?></a>
      ]]>
      </add>
    </operation>
  </file>
  
  <file path="catalog/controller/total/coupon.php">
    <operation error="skip">
      <search>
      <![CDATA[
->getCoupon($coupon);
      ]]>
      </search>
      <add position="after">
      <![CDATA[
        $this->load->model('module/affiliate');
        $this->model_module_affiliate->isTrackingCoupon($coupon);
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/model/extension/total/coupon.php">
    <operation error="skip">
      <search>
      <![CDATA[
function getCoupon($code)
      ]]>
      </search>
      <add position="after">
      <![CDATA[
        $this->load->model('module/affiliate');
        $this->model_module_affiliate->isAffCoupon($code);
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/common/menu.tpl">
    <operation error="skip">
      <search>
      <![CDATA[$text_report_affiliate_activity;]]>
      </search>
      <add position="after">
      <![CDATA[
<li><a href="<?php echo $report_affiliate_statistics; ?>"><?php echo $text_report_affiliate_statistics; ?></a></li>
<li><a href="<?php echo $report_affiliate_statistics_all; ?>"><?php echo $text_report_affiliate_statistics_all; ?></a></li>
      ]]>
      </add>
    </operation>
  </file>
    <!--  Home :: Affiliate  -->
  <file path="admin/controller/marketing/affiliate.php">
    <operation error="skip">
      <search>
      <![CDATA[
$url = '';
      ]]>
      </search>
      <add position="after">
      <![CDATA[
if (isset($this->request->get['filter_request_payment'])) {
  $url .= '&filter_request_payment=' . $this->request->get['filter_request_payment'];
}
$data['sort_request_payment'] = $this->url->link('marketing/affiliate', 'token=' . $this->session->data['token'] . '&sort=a.request_payment' . $url, 'SSL');
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
function getList()
      ]]>
      </search>
      <add position="after">
      <![CDATA[
if (isset($this->request->get['filter_request_payment'])) {
  $filter_request_payment = $this->request->get['filter_request_payment'];
} else {
  $filter_request_payment = null;
}
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
$filter_status,
      ]]>
      </search>
      <add position="after">
      <![CDATA[
'filter_request_payment' => $filter_request_payment,
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
$data['affiliates'][]
      ]]>
      </search>
      <add position="after">
      <![CDATA[
'request_payment' => $this->currency->format($result['request_payment'], $this->config->get('config_currency')),
'request_payment_int' => $result['request_payment'],
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
$data['filter_status']
      ]]>
      </search>
      <add position="after">
      <![CDATA[
$data['column_request_payment'] = $this->language->get('column_request_payment');
$data['filter_request_payment'] = $filter_request_payment;
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        $data['text_bank']
      ]]>
      </search>
      <add position="after">
      <![CDATA[  
$data['text_bonus'] = $this->language->get('text_bonus');
$data['text_qiwi'] = $this->language->get('text_qiwi');
$data['text_card'] = $this->language->get('text_card');
$data['text_yandex'] = $this->language->get('text_yandex');
$data['text_webmoney_wmr'] = $this->language->get('text_webmoney_wmr');
$data['text_webmoney_wmz'] = $this->language->get('text_webmoney_wmz');
$data['text_webmoney_wmu'] = $this->language->get('text_webmoney_wmu');
$data['text_webmoney_wme'] = $this->language->get('text_webmoney_wme');
$data['text_webmoney_wmy'] = $this->language->get('text_webmoney_wmy');
$data['text_webmoney_wmb'] = $this->language->get('text_webmoney_wmb');
$data['text_webmoney_wmg'] = $this->language->get('text_webmoney_wmg');
$data['text_alert_pay'] = $this->language->get('text_alert_pay');
$data['text_moneybookers'] = $this->language->get('text_moneybookers');
$data['text_liqpay'] = $this->language->get('text_liqpay');
$data['text_sage_pay'] = $this->language->get('text_sage_pay');
$data['text_two_checkout'] = $this->language->get('text_two_checkout');
$data['text_google_wallet'] = $this->language->get('text_google_wallet');      
$data['entry_payment_comment'] = $this->language->get('entry_payment_comment');
$data['entry_qiwi'] = $this->language->get('entry_qiwi');
$data['entry_card'] = $this->language->get('entry_card');
$data['entry_yandex'] = $this->language->get('entry_yandex');
$data['entry_webmoney_wmr'] = $this->language->get('entry_webmoney_wmr');
$data['entry_webmoney_wmz'] = $this->language->get('entry_webmoney_wmz');
$data['entry_webmoney_wmu'] = $this->language->get('entry_webmoney_wmu');
$data['entry_webmoney_wme'] = $this->language->get('entry_webmoney_wme');
$data['entry_webmoney_wmy'] = $this->language->get('entry_webmoney_wmy');
$data['entry_webmoney_wmb'] = $this->language->get('entry_webmoney_wmb');
$data['entry_webmoney_wmg'] = $this->language->get('entry_webmoney_wmg');
$data['entry_alert_pay'] = $this->language->get('entry_alert_pay');
$data['entry_moneybookers'] = $this->language->get('entry_moneybookers');
$data['entry_liqpay'] = $this->language->get('entry_liqpay');
$data['entry_sage_pay'] = $this->language->get('entry_sage_pay');
$data['entry_two_checkout'] = $this->language->get('entry_two_checkout');
$data['entry_google_wallet'] = $this->language->get('entry_google_wallet');
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
$this->model_marketing_affiliate->getAffiliate($this->request->get['affiliate_id']);
      ]]>
      </search>
      <add position="after" offset="2">
      <![CDATA[
if (isset($this->request->post['request_payment'])) {
  $data['request_payment'] = $this->request->post['request_payment'];
} elseif (!empty($affiliate_info)) {
  $data['request_payment'] = $affiliate_info['request_payment'];
} else {
  $data['request_payment'] = '';
}

$data['affiliate_bonus'] = (bool)$this->config->get('affiliate_bonus');
$data['affiliate_cheque'] = (bool)$this->config->get('affiliate_cheque');
$data['affiliate_paypal'] = (bool)$this->config->get('affiliate_paypal');
$data['affiliate_bank'] = (bool)$this->config->get('affiliate_bank');
$data['affiliate_qiwi'] = (bool)$this->config->get('affiliate_qiwi');
$data['affiliate_card'] = (bool)$this->config->get('affiliate_card');
$data['affiliate_yandex'] = (bool)$this->config->get('affiliate_yandex');
$data['affiliate_webmoney_wmr'] = (bool)$this->config->get('affiliate_webmoney_wmr');    
$data['affiliate_webmoney_wmz'] = (bool)$this->config->get('affiliate_webmoney_wmz');
$data['affiliate_webmoney_wmu'] = (bool)$this->config->get('affiliate_webmoney_wmu');
$data['affiliate_webmoney_wme'] = (bool)$this->config->get('affiliate_webmoney_wme');
$data['affiliate_webmoney_wmy'] = (bool)$this->config->get('affiliate_webmoney_wmy');
$data['affiliate_webmoney_wmb'] = (bool)$this->config->get('affiliate_webmoney_wmb');
$data['affiliate_webmoney_wmg'] = (bool)$this->config->get('affiliate_webmoney_wmg');
$data['affiliate_alert_pay'] = (bool)$this->config->get('affiliate_alert_pay');
$data['affiliate_moneybookers'] = (bool)$this->config->get('affiliate_moneybookers');
$data['affiliate_liqpay'] = (bool)$this->config->get('affiliate_liqpay');
$data['affiliate_sage_pay'] = (bool)$this->config->get('affiliate_sage_pay');
$data['affiliate_two_checkout'] = (bool)$this->config->get('affiliate_two_checkout');
$data['affiliate_google_wallet'] = (bool)$this->config->get('affiliate_google_wallet');
      
if (isset($this->request->post['qiwi'])) {
  $data['qiwi'] = $this->request->post['qiwi'];
} elseif (!empty($affiliate_info)) { 
  $data['qiwi'] = $affiliate_info['qiwi'];
} else {
  $data['qiwi'] = '';
}
if (isset($this->request->post['card'])) {
  $data['card'] = $this->request->post['card'];
} elseif (!empty($affiliate_info)) { 
  $data['card'] = $affiliate_info['card'];
} else {
  $data['card'] = '';
}  
if (isset($this->request->post['yandex'])) {
  $data['yandex'] = $this->request->post['yandex'];
} elseif (!empty($affiliate_info)) { 
  $data['yandex'] = $affiliate_info['yandex'];
} else {
  $data['yandex'] = '';
}      
if (isset($this->request->post['webmoney_wmr'])) {
  $data['webmoney_wmr'] = $this->request->post['webmoney_wmr'];
} elseif (!empty($affiliate_info)) { 
  $data['webmoney_wmr'] = $affiliate_info['webmoney_wmr'];
} else {
  $data['webmoney_wmr'] = '';
}
if (isset($this->request->post['webmoney_wmz'])) {
  $data['webmoney_wmz'] = $this->request->post['webmoney_wmz'];
} elseif (!empty($affiliate_info)) { 
  $data['webmoney_wmz'] = $affiliate_info['webmoney_wmz'];
} else {
  $data['webmoney_wmz'] = '';
}
if (isset($this->request->post['webmoney_wmu'])) {
  $data['webmoney_wmu'] = $this->request->post['webmoney_wmu'];
} elseif (!empty($affiliate_info)) { 
  $data['webmoney_wmu'] = $affiliate_info['webmoney_wmu'];
} else {
  $data['webmoney_wmu'] = '';
}
if (isset($this->request->post['webmoney_wme'])) {
  $data['webmoney_wme'] = $this->request->post['webmoney_wme'];
} elseif (!empty($affiliate_info)) { 
  $data['webmoney_wme'] = $affiliate_info['webmoney_wme'];
} else {
  $data['webmoney_wme'] = '';
}
if (isset($this->request->post['webmoney_wmy'])) {
  $data['webmoney_wmy'] = $this->request->post['webmoney_wmy'];
} elseif (!empty($affiliate_info)) { 
  $data['webmoney_wmy'] = $affiliate_info['webmoney_wmy'];
} else {
  $data['webmoney_wmy'] = '';
}
if (isset($this->request->post['webmoney_wmb'])) {
  $data['webmoney_wmb'] = $this->request->post['webmoney_wmb'];
} elseif (!empty($affiliate_info)) { 
  $data['webmoney_wmb'] = $affiliate_info['webmoney_wmb'];
} else {
  $data['webmoney_wmb'] = '';
}
if (isset($this->request->post['webmoney_wmg'])) {
  $data['webmoney_wmg'] = $this->request->post['webmoney_wmg'];
} elseif (!empty($affiliate_info)) { 
  $data['webmoney_wmg'] = $affiliate_info['webmoney_wmg'];
} else {
  $data['webmoney_wmg'] = '';
}
if (isset($this->request->post['alert_pay'])) {
  $data['alert_pay'] = $this->request->post['alert_pay'];
} elseif (!empty($affiliate_info)) { 
  $data['alert_pay'] = $affiliate_info['alert_pay'];
} else {
  $data['alert_pay'] = '';
}

if (isset($this->request->post['moneybookers'])) {
  $data['moneybookers'] = $this->request->post['moneybookers'];
} elseif (!empty($affiliate_info)) { 
  $data['moneybookers'] = $affiliate_info['moneybookers'];
} else {
  $data['moneybookers'] = '';
}

if (isset($this->request->post['liqpay'])) {
  $data['liqpay'] = $this->request->post['liqpay'];
} elseif (!empty($affiliate_info)) { 
  $data['liqpay'] = $affiliate_info['liqpay'];
} else {
  $data['liqpay'] = '';
}

if (isset($this->request->post['sage_pay'])) {
  $data['sage_pay'] = $this->request->post['sage_pay'];
} elseif (!empty($affiliate_info)) { 
  $data['sage_pay'] = $affiliate_info['sage_pay'];
} else {
  $data['sage_pay'] = '';
}

if (isset($this->request->post['two_checkout'])) {
  $data['two_checkout'] = $this->request->post['two_checkout'];
} elseif (!empty($affiliate_info)) { 
  $data['two_checkout'] = $affiliate_info['two_checkout'];
} else {
  $data['two_checkout'] = '';
}

if (isset($this->request->post['google_wallet'])) {
  $data['google_wallet'] = $this->request->post['google_wallet'];
} elseif (!empty($affiliate_info)) { 
  $data['google_wallet'] = $affiliate_info['google_wallet'];
} else {
  $data['google_wallet'] = '';
}
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
$data['text_balance']
      ]]>
      </search>
      <add position="after">
      <![CDATA[
$data['request_payment'] = $this->currency->format($this->model_marketing_affiliate->getTransactionTotal($this->request->get['affiliate_id']), $this->config->get('config_currency'));
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search trim="true" index="0">
      <![CDATA[
$data['payment'] = $affiliate_info['payment'];
      ]]>
      </search>
      <add position="replace">
      <![CDATA[
$this->load->model('module/affiliate');
$data['payment'] = $this->model_module_affiliate->getPaymentAffiliate($affiliate_info);
$data['info_payment'] = $this->language->get('text_'.$data['payment']);
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search trim="true" index="0">
      <![CDATA[
$data['payment'] = 'cheque';
      ]]>
      </search>
      <add position="replace">
      <![CDATA[
$this->load->model('module/affiliate');
$data['payment'] = $this->model_module_affiliate->getPaymentAffiliate();
      ]]>
      </add>
    </operation>
  </file>
  <!-- admin model marketing affiliate -->
  <file path="admin/model/marketing/affiliate.php">
    <operation error="skip">
      <search>
      <![CDATA[
'a.status',
      ]]>
      </search>
      <add position="after">
      <![CDATA[
'a.request_payment',
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search trim="true" index="0">
      <![CDATA[
$message  = sprintf($this->language->get('text_transaction_received'), $this->currency->format($amount, $this->config->get('config_currency'))) . "\n\n";
      ]]>
      </search>
      <add position="replace">
      <![CDATA[
$this->load->model('module/affiliate');
$message  = '';
if ((float)$amount < 0) {
  $query_request_payment = $this->db->query("SELECT request_payment AS total FROM `" . DB_PREFIX . "affiliate` WHERE affiliate_id = '" . (int) $affiliate_id . "'");
  $request_payment_value = $query_request_payment->row['total'] + $amount;
  if ($request_payment_value < 0) {
    $request_payment_value = 0.00;
  }
  $this->db->query("UPDATE `" . DB_PREFIX . "affiliate` SET request_payment = '" . $request_payment_value . "' WHERE affiliate_id = '" . (int) $affiliate_id . "'");
  $message = sprintf($this->language->get('text_transaction_paid'), $this->currency->format($amount * (-1), $this->config->get('config_currency')), $this->model_module_affiliate->valuePlayment($affiliate_info)) . "\n\n";
}
else {
  $message = sprintf($this->language->get('text_transaction_received'), $this->currency->format($amount, $this->config->get('config_currency'))) . "\n\n";
} 
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
if ($implode)
      ]]>
      </search>
      <add position="before">
      <![CDATA[
if (isset($data['filter_request_payment']) && !is_null($data['filter_request_payment'])) {
  if (((int) $data['filter_request_payment']) == 0) {
    $implode[] = "request_payment = '" . (int) $data['filter_request_payment'] . "'";
  } else {
    $implode[] = "request_payment > '" . 0 . "'";
  }
}
      ]]>
      </add>
    </operation>
    <operation>
      <search trim="true">
<![CDATA[affiliate SET firstname]]>
      </search>
      <add position="after">
<![CDATA[
if (!(isset($affiliate_id))) { $affiliate_id = $this->db->getLastId(); }
$this->db->query("UPDATE `" . DB_PREFIX . "affiliate` SET qiwi = '" . $this->db->escape($data['qiwi']) . "', card = '" . $this->db->escape($data['card']) . "', yandex = '" . $this->db->escape($data['yandex']) . "', webmoney_wmr = '" . $this->db->escape($data['webmoney_wmr']) . "', webmoney_wmz = '" . $this->db->escape($data['webmoney_wmz']) . "', webmoney_wmu = '" . $this->db->escape($data['webmoney_wmu']) . "', webmoney_wme = '" . $this->db->escape($data['webmoney_wme']) . "', webmoney_wmy = '" . $this->db->escape($data['webmoney_wmy']) . "', webmoney_wmb = '" . $this->db->escape($data['webmoney_wmb']) . "', webmoney_wmg = '" . $this->db->escape($data['webmoney_wmg']) . "', alert_pay = '" . $this->db->escape($data['alert_pay']) .  "', moneybookers = '" . $this->db->escape($data['moneybookers']) .  "', liqpay = '" . $this->db->escape($data['liqpay']) . "', sage_pay = '" . $this->db->escape($data['sage_pay']) .  "', two_checkout = '" . $this->db->escape($data['two_checkout']) . "', google_wallet = '" . $this->db->escape($data['google_wallet']) . "' WHERE affiliate_id = '" . (int)$affiliate_id . "'");
]]>
      </add>
    </operation>
  </file>
    <!-- admin view template marketing affiliate_list -->
  <file path="admin/view/template/marketing/affiliate_list.tpl">
    <operation error="skip">
      <search>
      <![CDATA[
$column_balance;
      ]]>
      </search>
      <add position="after">
      <![CDATA[
<td class="text-right"><?php echo $column_request_payment; ?></td>
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
<button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button>
      ]]>
      </search>
      <add position="after" offset="2">
      <![CDATA[
<div class="form-group">
<label class="control-label" for="input-request_payment"><?php echo $column_request_payment; ?></label>
<select name="filter_request_payment" id="input-request_payment" class="form-control">
  <option value="*"></option>
  <?php if ($filter_request_payment) { ?>
  <option value="1" selected="selected"><?php echo $text_yes; ?></option>
  <?php } else { ?>
  <option value="1"><?php echo $text_yes; ?></option>
  <?php } ?>
  <?php if (($filter_request_payment !== null) && !$filter_request_payment) { ?>
  <option value="0" selected="selected"><?php echo $text_no; ?></option>
  <?php } else { ?>
  <option value="0"><?php echo $text_no; ?></option>
  <?php } ?>
</select>
</div>
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
$affiliate['balance'];
      ]]>
      </search>
      <add position="after">
      <![CDATA[
<?php if(0 < (double)$affiliate['request_payment_int']){ ?>
<td class="text-right" style='color:red' ><b><?php echo $affiliate['request_payment']; ?></b></td>
<?php }else{ ?>
<td class="text-right" ><?php echo $affiliate['request_payment']; ?></td>
<?php } ?>
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
location = url;
      ]]>
      </search>
      <add position="before" offset="0">
      <![CDATA[
var filter_request_payment = $('select[name=\'filter_request_payment\']').val();
if (filter_request_payment != '*') {
  url += '&filter_request_payment=' + encodeURIComponent(filter_request_payment); 
}
      ]]>
      </add>
    </operation>
  </file>
    <!-- admin view template marketing affiliate_form -->
  <file path="admin/view/template/marketing/affiliate_form.tpl">
    <operation error="skip">
      <search trim="true" index="0">
      <![CDATA[
<label class="col-sm-2 control-label"><?php echo $entry_payment; ?></label>
      ]]>
      </search>
      <add position="replace" offset="113">
      <![CDATA[
<label class="col-sm-2 control-label"><?php echo $entry_payment; ?></label>
<?php  
  if (file_exists(DIR_TEMPLATE.'sale/affiliate_form_wallet.tpl')) {
    require_once(DIR_TEMPLATE.'sale/affiliate_form_wallet.tpl');
  } 
?>
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/api/order.php">
    <operation error="skip">
      <search index="2">
      <![CDATA[
$this->model_checkout_order->addOrderHistory
      ]]>
      </search>
      <add position="after">
      <![CDATA[
$json['add'] = ((int)$this->config->get('affiliate_order_status_id') == (int)$this->request->post['order_status_id'] ? true : false);
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/sale/order_info.tpl">
    <operation error="skip">
      <search>
      <![CDATA[
$('textarea[name=\'comment\']').val('');
      ]]>
      </search>
      <add position="after">
      <![CDATA[
if (json['add']) {
  $('#button-commission-add').replaceWith('<button id="button-commission-remove" data-toggle="tooltip" title="<?php echo $button_commission_remove; ?>" class="btn btn-danger btn-xs"><i class="fa fa-minus-circle"></i></button>');
}
      ]]>
      </add>
    </operation>
  </file>
</modification>