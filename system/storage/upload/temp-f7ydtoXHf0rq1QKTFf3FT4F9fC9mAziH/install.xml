<?xml version="1.0" encoding="utf-8"?>
<modification>
  <code>affiliatemmm</code>
  <name>affiliatemmm</name>
  <version>4.0.2</version>
  <author>NeitrinoZull</author>
  <link>http://partnerkaprog.ru/</link>
  <file path="admin/controller/sale/order.php">
    <operation error="skip">
      <search>
      <![CDATA[
        $data['affiliate_id'] = $order_info['affiliate_id'];
      ]]>
      </search>
      <add position="after" offset="0">
      <![CDATA[
      $data['getaffiliates'] = array();
      if($order_info['affiliate_id']) {
        $getlevel = $this->config->get('affiliate_level_commission');
        $levelcount = count($getlevel);
        $this->load->model('module/affiliatemmm');
        $text = $this->model_module_affiliatemmm->getAffiliateParent((int)$order_info['affiliate_id'], 0, $levelcount);
        $data['getaffiliates'] = $this->model_module_affiliatemmm->getAffiliateCommission($text, $getlevel, $order_info);
      }
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        $data['commission']
      ]]>
      </search>
      <add position="before" offset="0">
      <![CDATA[
      $data['getaffiliates'] = array();
      if($order_info['affiliate_id']) {
        $getlevel = $this->config->get('affiliate_level_commission');
        $levelcount = count($getlevel);
        $this->load->model('module/affiliatemmm');
        $text = $this->model_module_affiliatemmm->getAffiliateParent((int)$order_info['affiliate_id'], 0, $levelcount);
        $data['getaffiliates'] = $this->model_module_affiliatemmm->getAffiliateCommission($text, $getlevel, $order_info);
      }
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/controller/catalog/product.php">
    <operation error="skip">
      <search>
      <![CDATA[
        $data['products'][]
      ]]>
      </search>
      <add position="before">
      <![CDATA[
    if ($special) {
          $price = $special;
      } else {
      $price = $result['price'];
    }
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        (isset($this->request->post['price']))
      ]]>
      </search>
      <add position="before">
      <![CDATA[
    if (isset($this->request->post['commission'])) {
          $data['commission'] = $this->request->post['commission'];
      } elseif (!empty($product_info)) {
      $data['commission'] = $product_info['affiliate_commission'];
    } else {
          $data['commission'] = '';
      }
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        $data['entry_price'] = $this->language->get('entry_price');
      ]]>
      </search>
      <add position="after">
      <![CDATA[
        $data['entry_commission'] = $this->language->get('entry_commission');
        $data['affiliate_product_commission'] = $this->config->get('affiliate_product_commission');
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        'price'      => $result['price'],
      ]]>
      </search>
      <add position="after">
      <![CDATA[
        'commission' => $price * $result['affiliate_commission'] / 100,
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
      $data['column_price'] = $this->language->get('column_price');
      ]]>
      </search>
      <add position="after">
      <![CDATA[
      $data['column_commission'] = $this->language->get('column_commission');
      $data['affiliate_product_commission'] = $this->config->get('affiliate_product_commission');
      ]]>
      </add>
    </operation>
  </file>
    <file path="admin/controller/extension/module/affiliate.php">
    <operation error="skip">
      <search>
      <![CDATA[
        'setting/setting'
      ]]>
      </search>
      <add position="before" offset="1">
      <![CDATA[
      $this->load->model('module/affiliatemmm');
        if ($this->request->server['REQUEST_METHOD'] != 'POST') {
          $this->model_module_affiliatemmm->createAffiliate();
        }
      if(isset($this->request->post['affiliate_level_commission'])){
        $count = 1;
        foreach ($this->request->post['affiliate_level_commission'] as $key => $value) {
          $value['level_id'] = $count;
          $this->request->post['affiliate_level_commission'][$key]['level_id'] = '' . $count;
          $count++;
        }
      }
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        $this->load->model('setting/setting');
      ]]>
      </search>
      <add position="before" offset="1">
      <![CDATA[
        $data['levels'] = array();
        if (isset($this->request->post['affiliate_level_commission'])) {
          $data['levels'] = $this->request->post['affiliate_level_commission'];
        } elseif ($this->config->get('affiliate_level_commission')) {
          $data['levels'] = $this->config->get('affiliate_level_commission');
        }
        $data['entry_affiliate_level'] = $this->language->get('entry_affiliate_level');
        $this->load->model('module/affiliatemmm');
        $data['entry_affiliate_commission'] = sprintf($this->language->get('entry_affiliate_commission'), $this->model_module_affiliatemmm->getAffiliateAllCommission(), '%');
        $data['entry_affiliate_count'] = $this->language->get('entry_affiliate_count');
        $data['button_add_level'] = $this->language->get('button_add_level');
        $data['entry_customer_lifetime'] = $this->language->get('entry_customer_lifetime');
        $data['entry_product_commission'] = $this->language->get('entry_product_commission');
        $data['affiliate_customer_lifetime'] = $this->config->get('affiliate_customer_lifetime');
        $data['affiliate_product_commission'] = $this->config->get('affiliate_product_commission');
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/model/catalog/product.php">
    <operation error="skip">
      <search>
      <![CDATA[
        (isset($data['image']))
      ]]>
      </search>
      <add position="before">
      <![CDATA[
    if (isset($data['commission'])) {
      $this->db->query("UPDATE `" . DB_PREFIX . "product` SET affiliate_commission = '" . $this->db->escape($data['commission']) . "' WHERE product_id = '" . (int)$product_id . "'");
    }
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        $data['keyword'] = '';
      ]]>
      </search>
      <add position="before">
      <![CDATA[
    $data['commission'] = $data['affiliate_commission'];
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/model/marketing/affiliate.php">
    <operation error="skip">
      <search>
      <![CDATA[
$affiliate_transaction_id = $this->db->getLastId();
      ]]>
      </search>
      <add position="after">
      <![CDATA[
      if($affiliate_id!=0 & $order_id != 0) {
        $this->load->model('sale/order');
        $order_info = $this->model_sale_order->getOrder($order_id);
        $this->load->model('module/affiliatemmm');
        $getlevel = $this->config->get('affiliate_level_commission');
        $levelcount = count($getlevel);
        $text = $this->model_module_affiliatemmm->getAffiliateParent((int)$affiliate_id, 0, $levelcount);
        $getaffiliates = $this->model_module_affiliatemmm->getAffiliateCommission($text, $getlevel, $order_info);
        foreach ($getaffiliates as $parentaffiliate) {
          if ((float)$parentaffiliate['total'] != 0.0) {
            $this->db->query("INSERT INTO `" . DB_PREFIX . "affiliate_transaction` SET affiliate_id = '" . (int)$parentaffiliate['affiliate_id'] . "', order_id = '" . (float)$order_id . "', description = '" . $this->db->escape($description). " (" .$affiliate_info['firstname'] ." ". $affiliate_info['lastname'] . ")', amount = '" . (float)$parentaffiliate['total'] . "', date_added = NOW(), affiliate_children = '" . $affiliate_id . "'");
          }
        }
      }
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/sale/order_info.tpl">
    <operation error="skip">
      <search index="0">
      <![CDATA[
        ($affiliate)
      ]]>
      </search>
      <add position="after" offset="13">
      <![CDATA[
      <?php foreach ($getaffiliates as $parentaffiliate) { ?>
      <tr>
            <td><?php echo $text_affiliate.'#'.$parentaffiliate['level']; ?>(
            <a href="<?php echo $parentaffiliate['link']; ?>"><?php echo $parentaffiliate['affiliate_name']; ?> </a>
            )</td>
            <td><?php echo $parentaffiliate['commission']; ?></td>
          </tr>
      <?php } ?>
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/catalog/product_list.tpl">
    <operation error="skip">
      <search index="1">
      <![CDATA[
        <?php echo $product['price']; ?>
      ]]>
      </search>
      <add position="after" offset="1">
      <![CDATA[
      <?php if ($affiliate_product_commission) { ?>
        <td class="left"><?php echo $product['commission']; ?></td>
      <?php } ?>
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        $sort == 'p.quantity'
      ]]>
      </search>
      <add position="before" offset="2">
      <![CDATA[
      <?php if ($affiliate_product_commission) { ?>
        <td class="left"><?php echo $column_commission; ?></td>
      <?php } ?>
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/catalog/product_form.tpl">
    <operation error="skip">
      <search>
      <![CDATA[
        <label class="col-sm-2 control-label" for="input-price"><?php echo $entry_price; ?></label>
      ]]>
      </search>
      <add position="after" offset="4">
      <![CDATA[
      <?php if ($affiliate_product_commission) { ?>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-commission"><?php echo $entry_commission; ?></label>
                <div class="col-sm-10">
                  <input type="text" name="commission" value="<?php echo $commission; ?>" id="input-commission" class="form-control" />
                </div>
              </div>
      <?php } ?>
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/extension/module/affiliate.tpl">
    <operation error="skip">
      <search>
      <![CDATA[
        <div class="form-group">
      ]]>
      </search>
      <add position="before">
      <![CDATA[
      <table class="table table-bordered">
      <tr>
          <td class="right"><?php echo $entry_customer_lifetime; ?> </br>
        <select name="affiliate_customer_lifetime">
                <?php if ($affiliate_customer_lifetime) { ?>
                <option value="1" selected="selected"><?php echo $text_enabled; ?></option>
                <option value="0"><?php echo $text_disabled; ?></option>
                <?php } else { ?>
                <option value="1"><?php echo $text_enabled; ?></option>
                <option value="0" selected="selected"><?php echo $text_disabled; ?></option>
                <?php } ?></td>
          <td><?php echo $entry_product_commission; ?></br>
        <select name="affiliate_product_commission">
                <?php if ($affiliate_product_commission) { ?>
                <option value="1" selected="selected"><?php echo $text_enabled; ?></option>
                <option value="0"><?php echo $text_disabled; ?></option>
                <?php } else { ?>
                <option value="1"><?php echo $text_enabled; ?></option>
                <option value="0" selected="selected"><?php echo $text_disabled; ?></option>
                <?php } ?></td>
      </tr>
      </table>
      <table id="level" class="table table-bordered table-hover">
        <thead>
        <tr>
          <td class="left"><?php echo $entry_affiliate_level; ?></td>
          <td class="left"><?php echo $entry_affiliate_commission; ?></td>
          <td class="left"><?php echo $entry_affiliate_count; ?></td>
          <td></td>
        </tr>
        </thead>
        <?php $level_row = 1; ?>
        <?php foreach ($levels as $level) { ?>
        <tbody id="level-row<?php echo $level_row; ?>">
        <tr>
          <td class="left">
            <input type="text" name="affiliate_level_commission[<?php echo $level_row; ?>][level_id]" value="<?php echo $level['level_id']; ?>" size="3" />
          </td>
          <td class="left">
            <input type="text" name="affiliate_level_commission[<?php echo $level_row; ?>][level_commission]" value="<?php echo $level['level_commission']; ?>" size="3" />
          </td>
          <td class="left">
            <input type="text" name="affiliate_level_commission[<?php echo $level_row; ?>][level_affiliate]" value="<?php echo $level['level_affiliate']; ?>" size="3" />
          </td>
          <td class="left"><a onclick="$('#level-row<?php echo $level_row; ?>').remove();" data-original-title="Delete" type="button" data-toggle="tooltip" title="" class="btn btn-danger"><i class="fa fa-trash-o"></a></td>
        </tr>
        </tbody>
        <?php $level_row++; ?>
        <?php } ?>
         <tfoot>
        <tr>
          <td colspan="3"></td>
          <td class="left"><a onclick="addLevel();" data-original-title="<?php echo $button_add_level; ?>" data-toggle="tooltip" title="" class="btn btn-primary" ><i class="fa fa-plus"></i></a></td>
        </tr>
        </tfoot>
      </table>
      ]]>
      </add>
    </operation>
    <operation error="skip">
      <search>
      <![CDATA[
        <?php echo $footer; ?>
      ]]>
      </search>
      <add position="before" offset="0">
      <![CDATA[
<script type="text/javascript"><!--
var level_row = <?php echo $level_row; ?>;

function addLevel() {  
  html  = '<tbody id="level-row' + level_row + '">';
  html += '  <tr>';
  html += '   <td class="left"> <input type="text" name="affiliate_level_commission[' + level_row + '][level_id]" value="'+level_row+'" size="3" /></td>';
  html += '   <td class="left"> <input type="text" name="affiliate_level_commission[' + level_row + '][level_commission]" value="5" size="3" /></td>';
  html += '   <td class="left"> <input type="text" name="affiliate_level_commission[' + level_row + '][level_affiliate]" value="0" size="3" /></td>';
  html += '    <td class="left"><a onclick="$(\'#level-row' + level_row + '\').remove();" data-original-title="Delete" type="button" data-toggle="tooltip" title="" class="btn btn-danger"><i class="fa fa-trash-o"></a></td>';
  html += '  </tr>';
  html += '</tbody>';
    
  $('#level tfoot').before(html);
  
  level_row++;
}
//--></script> 
]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/extension/module/affiliate.php">
    <operation error="skip">
      <search>
      <![CDATA[
        ('extension/module/affiliate')
      ]]>
      </search>
      <add position="after">
      <![CDATA[
        $data['level'] = $this->config->get('affiliate_level_commission');
        $data['text_statisticsmyaffiliate'] = $this->language->get('text_statisticsmyaffiliate');
        $data['statisticsmyaffiliate'] = $this->url->link('affiliate/statisticsmyaffiliate', '', 'SSL');
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/checkout/confirm.php">
    <operation error="skip">
      <search>
      <![CDATA[
        isset($this->request->cookie['tracking'])
      ]]>
      </search>
      <add position="before">
      <![CDATA[
        $this->load->model('module/statisticsmyaffiliate');
        $this->model_module_statisticsmyaffiliate->isAffiliate();
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/affiliate/tracking.php">
    <operation error="skip">
      <search>
      <![CDATA[
        $this->language->get('heading_title');
      ]]>
      </search>
      <add position="after">
      <![CDATA[
        $data['button_vk'] = $this->language->get('button_vk');
        $this->load->model('module/statisticsmyaffiliate');
        $data['register'] = $this->model_module_statisticsmyaffiliate->getRegUrl();
        $data['text_register_url'] = $this->language->get('text_register_url');
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/affiliate/account.php">
    <operation error="skip">
      <search>
      <![CDATA[
        $this->language->get('text_transaction');
      ]]>
      </search>
      <add position="after">
      <![CDATA[
                $data['level'] = $this->config->get('affiliate_level_commission');
                $data['text_my_statisticsmyaffiliate'] = $this->language->get('text_my_statisticsmyaffiliate');
                $data['text_statisticsmyaffiliate'] = $this->language->get('text_statisticsmyaffiliate');
                $data['statisticsmyaffiliate'] = $this->url->link('affiliate/statisticsmyaffiliate', '', 'SSL');
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/model/checkout/order.php">
    <operation error="skip">
      <search>
      <![CDATA[
        return $order_id;
      ]]>
      </search>
      <add position="before">
      <![CDATA[
      if($this->config->get('affiliate_product_commission')) {
        if(isset($this->request->cookie['tracking'])) {
          $this->load->model('affiliate/affiliate');
          $affiliate_info = $this->model_affiliate_affiliate->getAffiliateByCode($this->request->cookie['tracking']);
          $this->load->model('module/statisticsmyaffiliate');
          $affiliate_commission = $this->model_module_statisticsmyaffiliate->getOrderCommission($order_id) / 100;
          $this->db->query("UPDATE `" . DB_PREFIX . "order` SET commission = '" . $affiliate_commission . "' WHERE order_id = '" . (int)$order_id . "'");
        }
      }
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/model/affiliate/affiliate.php">
    <operation error="skip">
      <search>
      <![CDATA[
$affiliate_id = $this->db->getLastId();
      ]]>
      </search>
      <add position="after">
      <![CDATA[
       $levels = $this->config->get('affiliate_level_commission');
		$trackingmmm = isset($this->request->cookie['tracking']) ? $this->request->cookie['tracking'] : null;
		if (!isset($trackingmmm)) {
			$trackingmmm = isset($this->session->data['tracking']) ? $this->session->data['tracking'] : null;
		} 
		if (array_key_exists('tracking', $data)) {
            $trackingmmm = $data['tracking'];
		}
		
       if(isset($trackingmmm) & $levels) {
        $query = $this->db->query("SELECT affiliate_id FROM `" . DB_PREFIX . "affiliate` WHERE code = '" . $trackingmmm . "'");
        if ($query->num_rows) {
          $affiliate_parent = $query->row['affiliate_id'];
          $count_affiliate = $levels[1]['level_affiliate'];
          if($count_affiliate != 0) {
            $query = $this->db->query("SELECT count(*) as total FROM `" . DB_PREFIX . "affiliate` WHERE parent = '" . $affiliate_parent . "'");
            $count_affiliate_sql = $query->row['total'];
            if($count_affiliate_sql<$count_affiliate){
              $count_affiliate = 0;
            }
          }
          if($count_affiliate == 0) {
            $query_id = $this->db->query("SELECT affiliate_id FROM `" . DB_PREFIX . "affiliate` WHERE email = '" . $this->db->escape($data['email']) . "'");
            $affiliate_id = $query_id->row['affiliate_id'];
            $this->db->query("UPDATE `" . DB_PREFIX . "affiliate` SET parent = '" . $affiliate_parent . "' WHERE affiliate_id = '" . (int)$affiliate_id . "'");
          }
        }
      }
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/*/template/extension/module/affiliate.tpl">
    <operation error="skip">
      <search>
      <![CDATA[
        $text_transaction;
      ]]>
      </search>
      <add position="after">
      <![CDATA[
<?php if ($level) { ?>
<a href="<?php echo $statisticsmyaffiliate; ?>" class="list-group-item"><?php echo $text_statisticsmyaffiliate; ?></a>
<?php } ?>
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/*/template/affiliate/account.tpl">
    <operation error="skip">
      <search>
      <![CDATA[
        $text_transaction;
      ]]>
      </search>
      <add position="after" offset="1">
      <![CDATA[
<?php if ($level) { ?>
  <h2><?php echo $text_my_statisticsmyaffiliate; ?></h2>
    <ul class="list-unstyled">
      <li><a href="<?php echo $statisticsmyaffiliate; ?>"><?php echo $text_statisticsmyaffiliate; ?></a></li>
  </ul>
<?php } ?>
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/*/template/affiliate/tracking.tpl">
    <operation error="skip">
      <search trim="true" index="0">
      <![CDATA[<h1><?php echo $heading_title; ?></h1>]]>
      </search>
      <add position="after">
<![CDATA[
<?php  
  if (file_exists(DIR_TEMPLATE.'default/template/affiliate/trackingmmmurl.tpl')) {
    require_once(DIR_TEMPLATE.'default/template/affiliate/trackingmmmurl.tpl');
  } 
?>
]]>
      </add>
    </operation>
  </file>
  <!--
  <file path="system/library/affiliate.php">
    <operation error="skip">
      <search>
        <![CDATA[unset($this->session->data['affiliate_id']);]]>
      </search>
      <add position="after">
<![CDATA[if (isset($this->session->data['children_level'])) { unset($this->session->data['children_level']); }]]>
      </add>
    </operation>
  </file>
  -->
</modification>